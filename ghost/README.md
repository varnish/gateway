<!--

   !!!!!!  WARNING: DO NOT EDIT THIS FILE!

   This file was generated from the Varnish VMOD source code.
   It will be automatically updated on each build.

-->
# Varnish Module (VMOD) `ghost`

Ghost VMOD - Gateway API routing for Varnish

Ghost is a purpose-built Varnish VMOD for Kubernetes Gateway API implementation.
It handles virtual host routing, backend selection, and configuration hot-reloading.

### Features

- **Virtual host routing**: Route requests based on the Host header
- **Exact hostname matching**: `api.example.com`
- **Wildcard hostname matching**: `*.staging.example.com` (single label only, per Gateway API spec)
- **Weighted backend selection**: Distribute traffic across backends by weight
- **Hot configuration reload**: Update routing without restarting Varnish
- **Default backend fallback**: Catch-all for unmatched requests

### Minimal VCL Example

```vcl
vcl 4.1;

import ghost;

sub vcl_init {
## Initialize ghost with the configuration file path
ghost.init("/etc/varnish/ghost.json");

## Create the ghost backend router
new router = ghost.ghost_backend();
}

sub vcl_recv {
## Handle configuration reload requests
## Returns JSON response for /.varnish-ghost/reload
set req.http.x-ghost-reload = ghost.recv();
if (req.http.x-ghost-reload) {
return (synth(200, "Reload"));
}
}

sub vcl_synth {
## Return reload response
if (req.http.x-ghost-reload) {
set resp.http.content-type = "application/json";
set resp.body = req.http.x-ghost-reload;
return (deliver);
}
}

sub vcl_backend_fetch {
## Use ghost for backend selection based on Host header
set bereq.backend = router.backend();
}
```

### Configuration File Format (ghost.json)

```json
{
"version": 1,
"vhosts": {
"api.example.com": {
"backends": [
{"address": "10.0.0.1", "port": 8080, "weight": 100},
{"address": "10.0.0.2", "port": 8080, "weight": 100}
]
},
"*.staging.example.com": {
"backends": [
{"address": "10.0.2.1", "port": 8080, "weight": 100}
]
}
},
"default": {
"backends": [
{"address": "10.0.99.1", "port": 80, "weight": 100}
]
}
}
```

### Error Responses

- **404 Not Found**: No virtual host matched and no default configured
- **503 Service Unavailable**: Virtual host matched but has no backends

Both error responses include a JSON body with details.

### Hot Reload

Trigger a configuration reload by sending:

```bash
curl http://localhost/.varnish-ghost/reload
```

Returns `{"status": "ok", "message": "configuration reloaded"}` on success.

```vcl
// Place import statement at the top of your VCL file
// This loads vmod from a standard location
import ghost;

// Or load vmod from a specific file
import ghost from "path/to/libghost.so";
```

### Function `VOID ghost.init(STRING path)`

Initialize ghost with a configuration file path.

This function must be called in `vcl_init` before creating any ghost backends.
It loads and validates the JSON configuration file.

#### Arguments

* `path` - Absolute path to the ghost configuration JSON file

#### Errors

Returns an error if the configuration file cannot be read or contains invalid JSON.

#### Example

```vcl
sub vcl_init {
ghost.init("/etc/varnish/ghost.json");
}
```

### Function `STRING ghost.recv()`

Handle reload requests in `vcl_recv`.

Checks if the current request is a configuration reload request
(path `/.varnish-ghost/reload`). If so, reloads the configuration
from disk and returns a JSON status message.

#### Returns

- `None` if this is a normal request (not a reload request)
- `Some(json)` if this is a reload request, containing the status

#### Example

```vcl
sub vcl_recv {
set req.http.x-ghost-reload = ghost.recv();
if (req.http.x-ghost-reload) {
return (synth(200, "Reload"));
}
}

sub vcl_synth {
if (req.http.x-ghost-reload) {
set resp.http.content-type = "application/json";
set resp.body = req.http.x-ghost-reload;
return (deliver);
}
}
```

### Constructor `ghost.ghost_backend()`

Ghost backend object for request routing.

The ghost backend routes requests to upstream servers based on the
Host header and the loaded configuration. It performs weighted random
selection when multiple backends are available for a virtual host.

#### Example

```vcl
sub vcl_init {
ghost.init("/etc/varnish/ghost.json");
new router = ghost.ghost_backend();
}

sub vcl_backend_fetch {
set bereq.backend = router.backend();
}
```

Create a new ghost backend instance.

Must be called after `ghost.init()` has been called.

##### Errors

Returns an error if `ghost.init()` has not been called first.

#### Method `BACKEND <object>.backend()`

Get the VCL backend for use in `vcl_backend_fetch`.

When this backend is used, ghost will:
1. Match the request's Host header against configured virtual hosts
2. Select a backend using weighted random selection
3. Forward the request to the selected backend
4. Return the response (or a synthetic 404/503 on error)

##### Example

```vcl
sub vcl_backend_fetch {
set bereq.backend = router.backend();
}
```
