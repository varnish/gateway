varnishtest "URL rewrite filter - ReplacePrefixMatch accuracy"

# Test the accurate ReplacePrefixMatch implementation

# Backend server
server s1 {
    # Test 1: Basic prefix replacement
    rxreq
    expect req.url == "/api/v2/users"
    txresp -body "OK"

    # Test 2: With query string
    rxreq
    expect req.url == "/api/v2/users?page=2"
    txresp -body "OK"

    # Test 3: Longer path
    rxreq
    expect req.url == "/api/v2/users/123/profile"
    txresp -body "OK"
} -start

# Write config
shell {
    cat > ${tmpdir}/ghost.json <<EOF
{
    "version": 2,
    "vhosts": {
        "test.example.com": {
            "routes": [
                {
                    "path_match": {
                        "type": "PathPrefix",
                        "value": "/api/v1"
                    },
                    "backends": [
                        {"address": "${s1_addr}", "port": ${s1_port}, "weight": 100}
                    ],
                    "filters": {
                        "url_rewrite": {
                            "path_type": "ReplacePrefixMatch",
                            "replace_prefix_match": "/api/v2"
                        }
                    },
                    "priority": 100
                }
            ]
        }
    }
}
EOF
}

varnish v1 -arg "-p thread_pool_stack=160k" -vcl {
    import ghost from "${vmod}";

    backend dummy none;

    sub vcl_init {
        ghost.init("${tmpdir}/ghost.json");
        new router = ghost.ghost_backend();
    }

    sub vcl_recv {
        if (req.url == "/.varnish-ghost/reload") {
            if (router.reload()) {
                return (synth(200, "OK"));
            } else {
                return (synth(500, "Reload failed"));
            }
        }
    }

    sub vcl_backend_fetch {
        set bereq.backend = router.backend();
    }
} -start

# Initial reload
client c_reload {
    txreq -url "/.varnish-ghost/reload"
    rxresp
    expect resp.status == 200
} -run

# Test 1: /api/v1/users -> /api/v2/users
client c1 {
    txreq -url "/api/v1/users" -hdr "Host: test.example.com"
    rxresp
    expect resp.status == 200
} -run

# Test 2: Query string preserved
client c2 {
    txreq -url "/api/v1/users?page=2" -hdr "Host: test.example.com"
    rxresp
    expect resp.status == 200
} -run

# Test 3: Longer paths
client c3 {
    txreq -url "/api/v1/users/123/profile" -hdr "Host: test.example.com"
    rxresp
    expect resp.status == 200
} -run
