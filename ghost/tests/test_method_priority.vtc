varnishtest "ghost method vs path priority - path-only should outrank method-only"

# Backend for path-match route (PathPrefix /path5 -> v1)
server s1 {
    rxreq
    expect req.method == "PATCH"
    expect req.url == "/path5"
    txresp -body "path-match-v1"
} -start

# Backend for method-match route (method PATCH -> v2)
server s2 {
    rxreq
    txresp -body "method-match-v2"
} -start

# Write config that mirrors the conformance test scenario:
# Rule 6: PathPrefix /path5 (no method) -> v1 (priority 10600)
# Rule 7: method PATCH (no path) -> v2 (priority 5000)
shell {
    cat > ${tmpdir}/ghost.json <<EOF
{
    "version": 2,
    "vhosts": {
        "*": {
            "routes": [
                {
                    "path_match": {
                        "type": "PathPrefix",
                        "value": "/path5"
                    },
                    "backends": [
                        {"address": "${s1_addr}", "port": ${s1_port}, "weight": 100}
                    ],
                    "priority": 10600,
                    "rule_index": 6
                },
                {
                    "method": "PATCH",
                    "backends": [
                        {"address": "${s2_addr}", "port": ${s2_port}, "weight": 100}
                    ],
                    "priority": 5000,
                    "rule_index": 7
                }
            ]
        }
    }
}
EOF
}

varnish v1 -arg "-p thread_pool_stack=160k" -vcl {
    import ghost from "${vmod}";

    backend dummy none;

    sub vcl_init {
        ghost.init("${tmpdir}/ghost.json");
        new router = ghost.ghost_backend();
    }

    sub vcl_recv {
        if (req.url == "/.varnish-ghost/reload") {
            if (router.reload()) {
                return (synth(200, "OK"));
            } else {
                return (synth(500, "Reload failed"));
            }
        }
    }

    sub vcl_backend_fetch {
        set bereq.backend = router.backend();
    }
} -start

# Reload to load configuration
client c_reload {
    txreq -url "/.varnish-ghost/reload"
    rxresp
    expect resp.status == 200
} -run

# Test: PATCH /path5 should go to s1 (path match, priority 10600)
# NOT s2 (method match, priority 5000)
client c1 {
    txreq -req PATCH -url "/path5" -hdr "Host: anything.example.com"
    rxresp
    expect resp.status == 200
    expect resp.body == "path-match-v1"
} -run
