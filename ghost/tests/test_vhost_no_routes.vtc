varnishtest "vhost defined with empty routes array"

# Test that ghost correctly handles vhosts that have no routes defined.
# This can happen when a vhost is configured but has no backends ready yet.
# Expected behavior: config loads successfully, requests return 404.

# Write config with vhosts that have empty routes arrays
shell {
    cat > ${tmpdir}/ghost.json <<EOF
{
    "version": 2,
    "vhosts": {
        "alpha.example.com": {
            "routes": []
        },
        "api.example.com": {
            "routes": []
        }
    }
}
EOF
}

varnish v1 -arg "-p thread_pool_stack=160k" -vcl {
    import ghost from "${vmod}";

    backend dummy none;

    sub vcl_init {
        ghost.init("${tmpdir}/ghost.json");
        new router = ghost.ghost_backend();
    }

    sub vcl_recv {
        # Intercept reload requests and bypass cache
        if (req.url == "/.varnish-ghost/reload") {
            if (router.reload()) {
                return (synth(200, "OK"));
            } else {
                return (synth(500, "Reload failed"));
            }
        }
    }

    sub vcl_backend_fetch {
        set bereq.backend = router.backend();
    }
} -start

# Initial reload to load configuration
client c_reload {
    txreq -url "/.varnish-ghost/reload"
    rxresp
    expect resp.status == 200
} -run

# Test 1: alpha.example.com has no routes, should return 404
client c1 {
    txreq -hdr "Host: alpha.example.com"
    rxresp
    expect resp.status == 404
    expect resp.http.Content-Type == "text/plain"
    expect resp.body == "vhost not found"
} -run

# Test 2: api.example.com has no routes, should also return 404
client c2 {
    txreq -hdr "Host: api.example.com"
    rxresp
    expect resp.status == 404
    expect resp.http.Content-Type == "text/plain"
    expect resp.body == "vhost not found"
} -run

# Test 3: Undefined vhost should also return 404
client c3 {
    txreq -hdr "Host: unknown.example.com"
    rxresp
    expect resp.status == 404
    expect resp.http.Content-Type == "text/plain"
    expect resp.body == "vhost not found"
} -run
