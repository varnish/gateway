varnishtest "ghost reload error reporting"

# Test that reload errors are properly logged and accessible via last_error()

# Write an invalid config (wrong version)
shell {
    cat > ${tmpdir}/ghost.json <<EOF
{
    "version": 1,
    "vhosts": {}
}
EOF
}

varnish v1 -arg "-p thread_pool_stack=160k" -vcl {
    import ghost from "${vmod}";

    backend dummy none;

    sub vcl_init {
        ghost.init("${tmpdir}/ghost.json");
        new router = ghost.ghost_backend();
    }

    sub vcl_recv {
        # Intercept reload requests
        if (req.url == "/.varnish-ghost/reload") {
            if (router.reload()) {
                return (synth(200, "OK"));
            } else {
                # Store error message for vcl_synth
                set req.http.X-Ghost-Error = router.last_error();
                return (synth(500, "Reload failed"));
            }
        }
    }

    sub vcl_synth {
        # Handle reload endpoint responses
        if (req.url == "/.varnish-ghost/reload") {
            set resp.http.Content-Type = "text/plain";
            if (resp.status == 200) {
                synthetic("Reload successful");
            } else {
                set resp.http.X-Ghost-Error = req.http.X-Ghost-Error;
                synthetic("Reload failed: " + req.http.X-Ghost-Error);
            }
            return (deliver);
        }
    }

    sub vcl_backend_fetch {
        set bereq.backend = router.backend();
    }
} -start

# Test reload with invalid config
client c1 {
    txreq -url "/.varnish-ghost/reload"
    rxresp
    expect resp.status == 500
    expect resp.http.Content-Type == "text/plain"
    expect resp.http.X-Ghost-Error ~ "unsupported config version"
    expect resp.body ~ "Reload failed"
    expect resp.body ~ "unsupported config version"
} -run

# Fix the config
shell {
    cat > ${tmpdir}/ghost.json <<EOF
{
    "version": 2,
    "vhosts": {}
}
EOF
}

# Test reload with valid config
client c2 {
    txreq -url "/.varnish-ghost/reload"
    rxresp
    expect resp.status == 200
    expect resp.http.Content-Type == "text/plain"
    expect resp.body == "Reload successful"
} -run

# last_error() should now return empty string (reload again to verify)
client c3 {
    txreq -url "/.varnish-ghost/reload"
    rxresp
    expect resp.status == 200
    expect resp.body == "Reload successful"
} -run
