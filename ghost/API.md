<!--

   !!!!!!  WARNING: DO NOT EDIT THIS FILE!

   This file was generated from the Varnish VMOD source code.
   It will be automatically updated on each build.

-->
# Varnish Module (VMOD) `ghost`

Ghost VMOD - Gateway API routing for Varnish.

Routes requests by hostname and path to weighted backends using Varnish native
directors. Configuration is hot-reloaded from `ghost.json` without restarting Varnish.

### Minimal VCL Example

```vcl
vcl 4.1;

import ghost;

backend dummy { .host = "127.0.0.1"; .port = "80"; }

sub vcl_init {
ghost.init("/etc/varnish/ghost.json");
new router = ghost.ghost_backend();
}

sub vcl_recv {
if (req.url == "/.varnish-ghost/reload" && (client.ip == "127.0.0.1" || client.ip == "::1")) {
return (pass);
}
}

sub vcl_backend_fetch {
set bereq.backend = router.backend();
}
```

```vcl
// Place import statement at the top of your VCL file
// This loads vmod from a standard location
import ghost;

// Or load vmod from a specific file
import ghost from "path/to/libghost.so";
```

### Function `VOID ghost.init(STRING path)`

Initialize ghost with a configuration file path.

This function must be called in `vcl_init` before creating any ghost backends.
It loads and validates the JSON configuration file.

#### Arguments

* `path` - Absolute path to the ghost configuration JSON file

#### Errors

Returns an error if the configuration file cannot be read or contains invalid JSON.

#### Example

```vcl
sub vcl_init {
ghost.init("/etc/varnish/ghost.json");
}
```

### Function `STRING ghost.recv()`

Pre-routing hook for `vcl_recv`. Currently a no-op, reserved for future use.

### Function `VOID ghost.deliver()`

Deliver hook for response header modification.

Call this in `vcl_deliver` to apply ResponseHeaderModifier filters.
Reads filter context from response headers (copied from bereq in vcl_backend_response).

### Constructor `ghost.ghost_backend()`

Ghost backend object for request routing.

The ghost backend routes requests to upstream servers based on the
Host header and the loaded configuration. It performs weighted random
selection when multiple backends are available for a virtual host.

Uses the director pattern with Varnish native backends for optimal
performance and connection pooling.

#### Example

```vcl
sub vcl_init {
ghost.init("/etc/varnish/ghost.json");
new router = ghost.ghost_backend();
}

sub vcl_backend_fetch {
set bereq.backend = router.backend();
}
```

Create a new ghost backend instance.

Must be called after `ghost.init()` has been called. If the config
file (ghost.json) already exists on disk, routing state is loaded
immediately. Otherwise the director starts empty and backends will
be populated on the first `reload()` call from chaperone.

##### Errors

Returns an error if `ghost.init()` has not been called first.

#### Method `BACKEND <object>.backend()`

Get the VCL backend for use in `vcl_backend_fetch`.

Matches the Host header against configured virtual hosts, selects a
backend by weighted random, and returns a native Varnish backend.

##### Example

```vcl
sub vcl_backend_fetch {
set bereq.backend = router.backend();
}
```

#### Method `BOOL <object>.reload()`

Reload the configuration for this ghost backend.

Reloads the ghost.json configuration file and updates routing state.
New backends are created as needed, existing backends are preserved
for connection pooling.

Errors are logged to VSL (varnishlog) and can be retrieved via `last_error()`.

##### Returns

- `true` on success
- `false` on failure (check `last_error()` for details)

##### Example

```vcl
sub vcl_recv {
if (req.url == "/.varnish-ghost/reload" && (client.ip == "127.0.0.1" || client.ip == "::1")) {
if (router.reload()) {
return (synth(200, "OK"));
} else {
set req.http.X-Ghost-Error = router.last_error();
return (synth(500, "Reload failed"));
}
}
}
```

#### Method `STRING <object>.last_error()`

Get the last reload error message, or empty string if no error.
