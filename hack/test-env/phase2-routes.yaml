# Phase 2 Path-Based Routing Test Configuration
# Tests: exact, prefix, and regex path matching with route ordering

---
# Test 1: Prefix path matching
# api.example.com with different path prefixes
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: api-routes
  namespace: default
spec:
  parentRefs:
    - name: varnish-gateway
      namespace: default
  hostnames:
    - "api.example.com"
  rules:
    # Most specific first - exact match
    - matches:
        - path:
            type: Exact
            value: /api/v1/health
      backendRefs:
        - name: app-alpha
          port: 8080

    # Specific prefix
    - matches:
        - path:
            type: PathPrefix
            value: /api/v2/
      backendRefs:
        - name: app-beta
          port: 8080

    # Broader prefix
    - matches:
        - path:
            type: PathPrefix
            value: /api/v1/
      backendRefs:
        - name: app-gamma
          port: 8080

    # Catch-all for /api
    - matches:
        - path:
            type: PathPrefix
            value: /api/
      backendRefs:
        - name: app-delta
          port: 8080

    # Default for everything else
    - backendRefs:
        - name: app-epsilon
          port: 8080

---
# Test 2: Exact path matching on different paths
# Demonstrates that exact matches take precedence
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: static-routes
  namespace: default
spec:
  parentRefs:
    - name: varnish-gateway
      namespace: default
  hostnames:
    - "static.example.com"
  rules:
    - matches:
        - path:
            type: Exact
            value: /index.html
      backendRefs:
        - name: app-alpha
          port: 8080

    - matches:
        - path:
            type: Exact
            value: /about.html
      backendRefs:
        - name: app-beta
          port: 8080

    - matches:
        - path:
            type: Exact
            value: /contact.html
      backendRefs:
        - name: app-gamma
          port: 8080

    # Prefix for /assets/
    - matches:
        - path:
            type: PathPrefix
            value: /assets/
      backendRefs:
        - name: app-delta
          port: 8080

    # Default handler
    - backendRefs:
        - name: app-epsilon
          port: 8080

---
# Test 3: Blog with regex path matching
# Matches blog posts with numeric IDs
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: blog-routes
  namespace: default
spec:
  parentRefs:
    - name: varnish-gateway
      namespace: default
  hostnames:
    - "blog.example.com"
  rules:
    # Admin exact paths
    - matches:
        - path:
            type: Exact
            value: /admin
      backendRefs:
        - name: app-alpha
          port: 8080

    # Numeric post IDs (regex)
    - matches:
        - path:
            type: RegularExpression
            value: "^/posts/[0-9]+$"
      backendRefs:
        - name: app-beta
          port: 8080

    # UUID post IDs (regex)
    - matches:
        - path:
            type: RegularExpression
            value: "^/posts/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$"
      backendRefs:
        - name: app-gamma
          port: 8080

    # All other posts (prefix)
    - matches:
        - path:
            type: PathPrefix
            value: /posts/
      backendRefs:
        - name: app-delta
          port: 8080

    # Categories
    - matches:
        - path:
            type: PathPrefix
            value: /categories/
      backendRefs:
        - name: app-epsilon
          port: 8080

    # Default
    - backendRefs:
        - name: app-alpha
          port: 8080

---
# Test 4: Mixed specificity test
# Demonstrates route ordering with overlapping paths
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: mixed-routes
  namespace: default
spec:
  parentRefs:
    - name: varnish-gateway
      namespace: default
  hostnames:
    - "mixed.example.com"
  rules:
    # Most specific - exact
    - matches:
        - path:
            type: Exact
            value: /users/admin
      backendRefs:
        - name: app-alpha
          port: 8080

    # Specific regex pattern
    - matches:
        - path:
            type: RegularExpression
            value: "^/users/[0-9]+$"
      backendRefs:
        - name: app-beta
          port: 8080

    # Less specific prefix
    - matches:
        - path:
            type: PathPrefix
            value: /users/
      backendRefs:
        - name: app-gamma
          port: 8080

    # Root prefix
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: app-delta
          port: 8080
